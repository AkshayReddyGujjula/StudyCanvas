StudyCanvas â€” MVP Documentation (v7 â€” Final)
1. Project Overview
Name: StudyCanvas
Tagline: Every other AI gives you a conversation. We give you a map of your understanding.

Core Problem: Standard AI chat interfaces return long, linear responses. Students lose spatial context scrolling between an original explanation and its clarifications. The source material (lecture notes) exists in a separate window, forcing constant context-switching.

Solution: A spatial canvas where the lecture content is the centrepiece. Students upload a PDF, which is converted into structured, readable Markdown and rendered as the central node on an infinite canvas. Students highlight any text, click "Ask Gemini" on a floating popup, type their question, and receive an answer as a connected node placed beside the content. Questions about answers spawn further connected nodes, building a visual knowledge tree anchored to the original document.

Known MVP Limitation â€” Contextual Depth: When branching from an Answer Node, only the immediate parent's response is passed as conversational context. The full ancestor chain is not included. This is a deliberate scope decision.

2. Tech Stack
Layer	Technology	Justification
Frontend Framework	React + TypeScript	Type safety for complex, interconnected node state
Canvas	@xyflow/react (React Flow v12)	Purpose-built node-edge spatial UI; handles drag, zoom, pan natively
Markdown Rendering	react-markdown + remark-gfm + rehype-raw + rehype-sanitize	remark-gfm adds table/strikethrough; rehype-raw parses injected <mark> HTML into real DOM nodes; rehype-sanitize removes dangerous HTML from PDF-sourced content. Plugin order is critical: [rehypeRaw, rehypeSanitize] â€” rehype-raw must run first to parse raw HTML nodes before rehype-sanitize can traverse and filter them. [FIXED v7 â€” Flaw 2]
Markdown Styling	@tailwindcss/typography	Tailwind's preflight CSS reset strips all default element styles. The prose class from this plugin restores correct heading hierarchy, list bullets, code formatting, and paragraph spacing for all Markdown-rendered content
rehype-sanitize schema	defaultSchema extended with mark	[FIXED v7 â€” Bug 1] rehype-sanitize must be configured by spreading defaultSchema and extending it to additionally allow mark elements with className and data-highlight-id attributes. Using a mark-only schema would strip all standard Markdown-rendered HTML (p, h1â€“h6, ul, li, code, etc.), rendering the Content Node empty
State Management	Zustand	Lightweight; manages nodes, edges, fileData, highlights, and activeAbortController
Styling	Tailwind CSS	Utility-first; rapid development
Backend	Python + FastAPI	Fast to write, async-native
PDF Text Extraction	PyMuPDF (fitz)	Extracts full text from PDFs locally and instantly; no external dependency
AI Model	gemini-2.0-flash via Gemini API	1M token context window allows full lecture text passed directly; fast generation
Streaming	Native browser fetch API with ReadableStream + AbortController	Axios cannot stream in the browser; fetch with ReadableStream is universally supported; AbortController enables clean stream cancellation on canvas reset
Non-Streaming HTTP	Axios	Upload and quiz endpoints only
Explicitly removed from stack:

Gemini File Search Tool â€” unreliable async processing delays; replaced with direct context injection

@react-pdf-viewer â€” text layer misalignment and React Flow mouse event conflicts; replaced with Markdown rendering

dagre â€” cannot handle dynamic-height nodes; replaced with manual positioning algorithm

uuid package â€” replaced with native crypto.randomUUID()

3. System Architecture
Data Flow
text
User uploads PDF
       â”‚
       â–¼
POST /api/upload
Backend: PyMuPDF extracts full text (inside try/finally) â†’ Gemini converts to Markdown
       â”‚
       â–¼
Returns: { markdown_content, filename, page_count, raw_text }
       â”‚
       â–¼
Frontend: Stores in Zustand; serialises to localStorage (lifecycle events only â€” never activeAbortController)
       â”‚
       â–¼
Content Node rendered with react-markdown + rehypePlugins=[rehypeRaw, rehypeSanitize] + prose prose-base class
       â”‚
       â–¼
User highlights text â†’ "âœ¨ Ask Gemini" popup (position: fixed, getBoundingClientRect())
       â”‚
       â–¼
Popup clicked â†’ nodeId pre-generated via crypto.randomUUID()
Question Modal opens
       â”‚
       â–¼
User submits â†’ highlight entry {id, text, nodeId} + Answer Node created with same nodeId
AbortController created; stored as activeAbortController (top-level Zustand field, transient, never serialised)
       â”‚
       â–¼
POST /api/query â†’ FastAPI StreamingResponse (text/plain, synchronous def generator)
Phase 1 [isLoading:true, isStreaming:true]: skeleton shown
Phase 2 [isLoading:false, isStreaming:true]: first chunk â†’ <pre font-sans text-sm leading-relaxed>
Phase 3 [isStreaming:false]: stream done â†’ single react-markdown parse with prose prose-sm
localStorage updated on isStreamingâ†’false only
activeAbortController cleared to null
       â”‚
       â–¼
User can highlight text in Answer Node â†’ branch further â†’ tree grows
Canvas Layout
text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           REACT FLOW CANVAS                                â”‚
â”‚                                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚   â”‚   CONTENT NODE   â”‚â”€â”€(sourceHandle:"right")â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚   â”‚   (Markdown)     â”‚                             â”‚ Answer Node  â”‚        â”‚
â”‚   â”‚                  â”‚                             â”‚   Node 1     â”‚â”€â”€(sourceHandle:"right")â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚   react-markdown â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚ Answer       â”‚â”‚
â”‚   â”‚   + prose class  â”‚â”€â”€(sourceHandle:"right")â”€â”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚ Node 1a      â”‚â”‚
â”‚   â”‚   [max-height    â”‚                             â”‚ Answer Node  â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚   â”‚    80vh,         â”‚                             â”‚   Node 2     â”‚                                            â”‚
â”‚   â”‚    overflow-y:   â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚   â”‚    scroll]       â”‚                                                                                         â”‚
â”‚   â”‚                  â”‚                                                                                         â”‚
â”‚   â”‚(sourceHandle:    â”‚â”€â”€(sourceHandle:"left")â”€â”€â–¶  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚   â”‚ "left")          â”‚                             â”‚ Answer Node  â”‚                                            â”‚
â”‚   â”‚                  â”‚                             â”‚  (left side) â”‚                                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚                                                               [MiniMap] â—»                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Edges always flow source â†’ child. Left-side children connect FROM the Content Node's "left" handle TO the Answer Node's "right" handle. Right-side connections use sourceHandle: "right" â†’ targetHandle: "left".

4. Detailed Feature Requirements
4.1 PDF Upload and Processing
Upload interface:

On first load, if no saved canvas state exists in localStorage, render a centred upload panel with a drag-and-drop zone and a "Browse files" button

If saved canvas state exists in localStorage, restore the canvas immediately â€” no upload panel shown

An "Upload new PDF" button is always visible in the top-left corner of the canvas

Clicking "Upload new PDF" must: (1) call activeAbortController?.abort() to terminate any in-progress stream [FIXED v7 â€” Flaw 3]; (2) call Zustand's resetCanvas() action, which resets all state â€” nodes, edges, highlights, fileData, and activeAbortController â€” to initial empty values; (3) clear localStorage; (4) render the upload panel

Only .pdf files accepted; all others rejected immediately with a visible error

Maximum file size 50MB; exceeded files rejected before upload begins

Loading state:

After file selection and upload initiation, the upload panel transitions to a loading state displaying the filename, an animated spinner, and the text "Processing your lecture..."

No interaction possible during this state; persists until /api/upload response is received

Backend processing (POST /api/upload):

PDF received and saved to a temporary path

All subsequent processing occurs inside a try/finally block; the temp file is deleted in the finally clause regardless of outcome

PyMuPDF extracts full text, inserting --- separators at page breaks

Raw text sent to gemini-2.0-flash with conversion prompt: preserve all headings, subheadings, lists, emphasis, equations, and definitions exactly; add ## Page X headers at --- separators; do not summarise or omit anything

Response payload: { markdown_content: string, raw_text: string, filename: string, page_count: number }

Canvas state persistence:

localStorage is written only on the following specific lifecycle events â€” never on every Zustand state change, and never during streaming chunk updates:

After successful upload response received

After any node's isStreaming transitions to false

After a status button click (understood / struggling)

When resetCanvas() is called (to clear it)

Serialised fields: markdown_content, raw_text, filename, page_count, nodes, edges, highlights

activeAbortController is a transient runtime field and must never be included in localStorage serialisation [FIXED v7 â€” Flaw 3]. It is always initialised to null on application load and canvas restore, regardless of stored state

On application load, localStorage is checked first; if studycanvas_state exists, canvas is restored immediately

Error handling:

Empty text from PyMuPDF â†’ HTTP 400: "This PDF appears to be scanned or image-based. Please upload a text-based PDF."

Gemini conversion failure â†’ fall back to raw text in the Content Node with a visible warning banner

4.2 The Content Node
Visual design:

Custom React Flow node; white background, subtle drop shadow, header bar

Header bar: filename and page count (e.g. Intro_to_ML.pdf â€” 15 pages)

Markdown content rendered with react-markdown, plugins applied in the following mandatory order: remarkPlugins={[remarkGfm]} and rehypePlugins={[rehypeRaw, rehypeSanitize(customSchema)]} [FIXED v7 â€” Flaw 2]

The react-markdown wrapper div must use Tailwind classes prose prose-base max-w-none to restore correct Markdown visual hierarchy

Fixed width: 700px; Markdown content area: max-height: 80vh, overflow-y: scroll

Required root element attribute:

The outermost wrapper div sets data-nodeid={id} â€” required by useTextSelection hook

Interaction isolation:

Scrollable interior marked with nodrag and nopan CSS classes

Header bar remains draggable for node repositioning

Connection handles:

Two handles: id="left" (left edge) and id="right" (right edge)

"right" is sourceHandle for right-side Answer Nodes; "left" is sourceHandle for left-side Answer Nodes

Highlight rendering [FIXED v7 â€” Bug 1, Flaw 2]:

The Zustand highlights array stores { id: string, text: string, nodeId: string } objects

Before passing markdown_content to react-markdown, a pre-render substitution function replaces matching highlight text substrings with <mark class="bg-yellow-200 cursor-pointer" data-highlight-id="{id}">{text}</mark> HTML

Code block protection: The substitution function must identify and skip all text between triple-backtick fences (\``...````) and between single inline backtick pairs. No substitution is performed on text within these ranges

All regex special characters in each highlight text string must be escaped before use

Substitutions applied longest-match first to avoid partial-match collisions

rehype-raw enables <mark> HTML rendering. rehype-sanitize is configured with a custom schema that extends defaultSchema â€” { ...defaultSchema, tagNames: [...(defaultSchema.tagNames ?? []), 'mark'], attributes: { ...defaultSchema.attributes, mark: ['className', 'dataHighlightId'] } } [FIXED v7 â€” Bug 1]. This preserves all standard safe HTML element permissions from defaultSchema (blocking script, iframe, event handlers etc.) while additionally permitting mark with its two specific attributes

The substitution result must be wrapped in useMemo, recomputing only when markdown_content or the highlights array reference changes

Clicking a <mark> element reads its data-highlight-id, looks up the corresponding nodeId, and pans the canvas to that Answer Node via setCenter

4.3 Text Selection and "Ask Gemini" Popup
Selection detection:

A mouseup listener on the document captures selection via window.getSelection()

Fewer than 3 characters selected â†’ no popup

Source node ID found via event.target.closest('[data-nodeid]') â€” if none found, no popup

Floating popup button:

Labelled "âœ¨ Ask Gemini"; positioned using window.getSelection().getRangeAt(0).getBoundingClientRect() offset slightly downward

Must use position: fixed CSS â€” getBoundingClientRect() returns viewport-relative coordinates; position: absolute would misalign on any scrolled page

Rendered as a React portal attached to document.body

Appears with 100ms fade-in animation

Dismissed via a mousedown listener on the document; the dismiss check uses event.target.closest('[data-popup="ask-gemini"]') â€” if this returns any element, the click is inside the popup (including child elements such as emoji spans) and must not dismiss it

4.4 Question Modal
nodeId pre-generation:

When the popup is clicked, the Answer Node's nodeId is generated immediately via crypto.randomUUID() and stored in component state alongside selectedText and sourceNodeId

This nodeId is shared by the highlight entry and the Answer Node â€” no pending state at any point

Modal contents:

Semi-transparent backdrop; centred card (max-width 500px)

Yellow quote block: selected text (truncated to 200 chars; full text on hover)

Label: "Your question"; auto-focused text input

"Ask" (indigo) and "Cancel" (grey) buttons; Enter triggers Ask; Escape triggers Cancel

Empty submission â†’ "Type a question first"

On submit:

Modal closes immediately

Highlight entry { id: crypto.randomUUID(), text: selectedText, nodeId: <pre-generated> } added to Zustand highlights array

Answer Node created in Zustand with same pre-generated nodeId, isLoading: true, isStreaming: true

A new AbortController is created; its instance stored as the top-level activeAbortController field in Zustand â€” not per-node, not in localStorage [FIXED v7 â€” Flaw 3]. There is only ever one active stream at a time; this single field suffices

The AbortController's signal is passed to the fetch() call in streamQuery()

Pre-render substitution on ContentNode now includes the new highlight, turning the selected text yellow immediately

4.5 Answer Nodes
Visual design:

Fixed width 360px; height grows dynamically

width: 360 only is set in the Zustand node object â€” no height value is set â€” React Flow v12 measures actual rendered height via ResizeObserver and stores it in node.measured?.height

Content layout: yellow quote block â†’ bold question subheading â†’ response area â†’ status buttons

Required root element attribute:

Outermost div sets data-nodeid={id}

Answer Node lifecycle:

Phase 1 â€” Loading: isLoading: true, isStreaming: true. No content received. Response area shows animated skeleton placeholder. Status buttons hidden.

Phase 2 â€” Streaming: First chunk received. isLoading: false, isStreaming: true. Skeleton replaced by <pre> with classes font-sans text-sm leading-relaxed whitespace-pre-wrap â€” matching the prose-sm font family and size to minimise layout shift at Phase 3. Content appended per-chunk. Status buttons still hidden.

Phase 3 â€” Complete: done: true from ReadableStream reader. isStreaming: false. <pre> switches to react-markdown with rehypePlugins={[rehypeRaw, rehypeSanitize(customSchema)]} and prose prose-sm max-w-none class â€” one single Markdown parse. Status buttons appear. activeAbortController cleared to null. localStorage updated.

Connection handles:

Four handles: id="top", id="right", id="bottom", id="left"

As edge target from Content Node: targetHandle: "left" (right-side) or targetHandle: "right" (left-side)

As edge source to child: always sourceHandle: "right"

Branching:

Text fully selectable; same useTextSelection hook and popup

Branch queries set parent_response to parent node's full answer text

4.6 Node Status System
Status	Trigger	Left Border	MiniMap Colour
loading	Node created (isLoading: true)	Grey pulsing	Grey
unread	isStreaming â†’ false	Blue	Blue
understood	"âœ“ Got it" clicked	Green	Green
struggling	"âœ— Struggling" clicked	Red	Red
Both status buttons are symmetric toggles â€” clicking an already-active status resets to unread

Status buttons render only when isStreaming: false

Status persisted in Zustand; included in lifecycle-event localStorage writes

4.7 Edges (Arrows)
Every child node creation generates a directed edge: source â†’ child

Explicit handle IDs required on every edge:

Content Node â†’ right-side Answer Node: sourceHandle: "right", targetHandle: "left"

Content Node â†’ left-side Answer Node: sourceHandle: "left", targetHandle: "right"

Answer Node â†’ child Answer Node: sourceHandle: "right", targetHandle: "left"

Style: indigo/purple, 2px stroke, smoothstep curve type

Edge labels: truncated question (max 35 chars + "..."); white background pill with 4px horizontal padding

While isStreaming: true: animated dashed. When isStreaming: false: solid

Edges not user-deletable in MVP

4.8 Node Positioning Algorithm
No external layout library.

Height reading: Individual heights read from node.measured?.height (React Flow v12) â€” not useNodesBounds, which returns combined bounding boxes. Any node with unavailable measured.height uses 200px default.

For nodes spawned from the Content Node:

First right-side child: (contentNodeX + 700 + 80, contentNodeY)

Subsequent right-side children: same X; Y = previous node's Y + (prevNode.measured?.height ?? 200) + 40

After 4 right-side direct children, new children go left: (contentNodeX - 360 - 80, contentNodeY); same Y-stacking logic; these use sourceHandle: "left"

For nodes spawned from an Answer Node:

Placed at (parentNodeX + 360 + 80, parentNodeY)

If bounding box overlaps an existing node, shift Y down by overlapping.measured?.height ?? 200 + 40

Post-stream overlap correction:

After any node's isStreaming â†’ false, re-run the full Y-position calculation for all direct children of the same parent on the same side

Iterates top-to-bottom using actual node.measured?.height values

Each node's Y = previous node's Y + actual height + 40 â€” cascades automatically

Canvas pan after new node placement:

Use setCenter(nodeCentreX, nodeCentreY) to pan the canvas to the new node [FIXED v7 â€” Issue 5]. fitBounds must not be used â€” it recalculates zoom level, which disorients the user mid-session. setCenter preserves current zoom and simply pans.

4.9 Revision Mode
Persistent "ğŸ“ Revision Mode" button in top-right corner

No struggling nodes â†’ toast: "Mark some nodes as 'Struggling' first to generate a targeted quiz."

Quiz generation: frontend sends all { highlightedText, question, answer } from struggling nodes + raw_text to POST /api/quiz

Gemini call uses generation_config with response_mime_type: "application/json" and response_schema as list[QuizQuestion] Pydantic model (question: str, options: dict with keys A/B/C/D, answer: Literal["A","B","C","D"], explanation: str)

Quiz UI: full-screen modal; one question at a time; progress indicator; 4 option cards; correct/wrong colouring + explanation; final score screen; "Close" returns to canvas

4.10 Canvas Controls
Built-in Controls (zoom, fit view) in bottom-left

MiniMap in bottom-right with status-colour custom nodes

F keyboard shortcut triggers fit view only when document.activeElement.tagName is not an input element

Dot grid <Background> component for spatial orientation

5. Backend API Specification
Environment and CORS
Backend .env: GEMINI_API_KEY=<key>

Frontend .env: VITE_API_BASE_URL=http://localhost:8000

FastAPI CORS middleware explicitly allows http://localhost:5173

POST /api/upload
Field	Detail
Input	multipart/form-data â€” single PDF file
Processing	Save temp file â†’ try/finally â†’ PyMuPDF extraction â†’ Gemini Markdown conversion â†’ finally: delete temp file
Output	{ markdown_content: string, raw_text: string, filename: string, page_count: number }
Errors	400: non-PDF or scanned PDF; 500: Gemini failure (fall back to raw text)
POST /api/query
Field	Detail
Input	{ question: string, highlighted_text: string, raw_text: string, parent_response: string | null }
Response type	FastAPI StreamingResponse with media_type="text/plain". The generator function must be a standard synchronous def generator [FIXED v7 â€” Flaw 4] â€” the google-generativeai SDK's generate_content(stream=True) call is a blocking synchronous operation; placing it inside an async def generator blocks FastAPI's event loop. FastAPI automatically wraps synchronous generators in iterate_in_threadpool(), running them in a thread pool and awaiting them without blocking 
. The generator calls model.generate_content(prompt, stream=True) and yields each decoded text chunk
System prompt â€” direct (parent_response is null)	Answer only from the document; be concise (360px card); use bullets; state if not in document; do not repeat the question
System prompt â€” branch (parent_response not null)	Prefer the document as primary source; use general knowledge where document lacks context â€” do not refuse; be concise; use bullets; do not repeat the question
Frontend consumption	fetch() with AbortController.signal; response.body.getReader(); TextDecoder decodes Uint8Array chunks; appended to node content in Zustand
Timeout	30 seconds; return 504 if exceeded
POST /api/quiz
Field	Detail
Input	{ struggling_nodes: [{ highlighted_text, question, answer }], raw_text: string }
Gemini config	generation_config with response_mime_type="application/json", response_schema=list[QuizQuestion] Pydantic model
Output	[{ question, options: {A, B, C, D}, answer: "A"|"B"|"C"|"D", explanation }]
Error handling	Validate against schema; retry once; return 500 if still invalid
6. File Structure
text
studycanvas/
â”‚
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ main.py                    # FastAPI app, CORS (localhost:5173), router registration
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ upload.py              # POST /api/upload
â”‚   â”‚   â”œâ”€â”€ query.py               # POST /api/query â€” StreamingResponse, text/plain, synchronous def generator
â”‚   â”‚   â””â”€â”€ quiz.py                # POST /api/quiz â€” response_schema enforced JSON
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ gemini_service.py      # Gemini calls; query uses sync def generator; quiz uses GenerationConfig with response_schema
â”‚   â”‚   â”œâ”€â”€ pdf_service.py         # PyMuPDF extraction logic
â”‚   â”‚   â””â”€â”€ file_service.py        # Temp file write/delete in try/finally
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ schemas.py             # Pydantic: UploadResponse, QueryRequest, QuizRequest, QuizQuestion
â”‚   â”œâ”€â”€ requirements.txt           # fastapi, uvicorn, pymupdf, google-generativeai, python-multipart, python-dotenv
â”‚   â””â”€â”€ .env                       # GEMINI_API_KEY
â”‚
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ .env                       # VITE_API_BASE_URL=http://localhost:8000
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ App.tsx                # Root: localStorage check â†’ upload panel OR canvas
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ Canvas.tsx         # React Flow wrapper, node types, background, controls, MiniMap
â”‚   â”‚   â”‚   â”œâ”€â”€ ContentNode.tsx    # data-nodeid={id}; prose prose-base max-w-none; 80vh scroll; handles "left"/"right"; rehypePlugins=[rehypeRaw, rehypeSanitize(customSchema)]; memo'd substitution with code-block protection
â”‚   â”‚   â”‚   â”œâ”€â”€ AnswerNode.tsx     # data-nodeid={id}; three-phase lifecycle (skeletonâ†’pre font-sansâ†’prose-sm react-markdown); rehypePlugins=[rehypeRaw, rehypeSanitize(customSchema)]; handles "top/right/bottom/left"; width:360 only, no height
â”‚   â”‚   â”‚   â”œâ”€â”€ AskGeminiPopup.tsx # Portal at document.body; position:fixed; getBoundingClientRect(); dismiss via closest('[data-popup="ask-gemini"]')
â”‚   â”‚   â”‚   â”œâ”€â”€ QuestionModal.tsx  # crypto.randomUUID() pre-generates nodeId; AbortController created and stored as top-level activeAbortController in Zustand
â”‚   â”‚   â”‚   â”œâ”€â”€ RevisionModal.tsx  # Full-screen quiz; one MCQ at a time; score screen
â”‚   â”‚   â”‚   â””â”€â”€ UploadPanel.tsx    # Drag-drop; loading state; file type/size validation
â”‚   â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”‚   â””â”€â”€ canvasStore.ts     # Zustand fields: nodes, edges, fileData, highlights {id,text,nodeId}[], activeAbortController (transient â€” never in localStorage); resetCanvas() calls activeAbortController?.abort() then clears all fields [FIXED v7 â€” Flaw 3, Issue 6]
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â””â”€â”€ useTextSelection.ts  # mouseup â†’ getSelection() â†’ closest('[data-nodeid]') â†’ {text, sourceNodeId, boundingRect}
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ studyApi.ts        # Axios: uploadPdf(), generateQuiz(); native fetch: streamQuery(signal) with ReadableStream + TextDecoder
â”‚   â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts           # NodeStatus, ContentNodeData, AnswerNodeData (isLoading, isStreaming), QuizQuestion, HighlightEntry
â”‚   â”‚   â””â”€â”€ utils/
â”‚   â”‚       â””â”€â”€ positioning.ts     # Manual algorithm; node.measured?.height ?? 200; setCenter pan; cascading post-stream correction
â”‚   â”œâ”€â”€ package.json               # @xyflow/react, zustand, axios, react-markdown, remark-gfm, rehype-raw, rehype-sanitize, @tailwindcss/typography
â”‚   â””â”€â”€ tailwind.config.js         # plugins: [require('@tailwindcss/typography')]
â”‚
â””â”€â”€ README.md
7. Build Timeline (24 Hours, Solo)
Window	Task	Risk	Notes
0:00â€“0:45	Scaffold: Vite + React + TS, FastAPI, all deps installed, CORS configured, VITE_API_BASE_URL set, @tailwindcss/typography in tailwind.config.js, Gemini API key verified	Low	Run and verify prose class renders correctly on a sample Markdown string before anything else
0:45â€“2:00	Backend /api/upload: PyMuPDF + Gemini Markdown conversion + try/finally deletion, tested in Postman with a real UCL lecture PDF	Medium	Verify Markdown output quality immediately
2:00â€“3:00	Backend /api/query: synchronous def generator + StreamingResponse(text/plain), both direct and branch prompt variants, confirmed streaming progressively in Postman	Medium	Confirm chunks arrive progressively â€” if all arrive at once, the generator is blocking incorrectly
3:00â€“5:00	Frontend: React Flow canvas + ContentNode: data-nodeid, prose prose-base, 80vh scroll, nodrag/nopan, rehypePlugins=[rehypeRaw, rehypeSanitize(customSchema)] correct plugin order, localStorage lifecycle-event saves, resetCanvas() with activeAbortController?.abort()	Medium	Verify prose renders headings and lists correctly; verify mark HTML renders without stripping
5:00â€“7:00	Frontend: useTextSelection hook + AskGeminiPopup portal (position: fixed, getBoundingClientRect(), closest() dismiss logic)	High	Core interaction â€” test on Chrome and Safari; test dismiss on child elements of the button
7:00â€“9:00	Frontend: QuestionModal (crypto.randomUUID() pre-generation), AnswerNode three-phase lifecycle (skeleton â†’ <pre font-sans> â†’ prose-sm react-markdown), AbortController as top-level Zustand field wired to fetch signal	High	First full end-to-end loop â€” most integration bugs surface here
9:00â€“10:00	Frontend: Edges with explicit sourceHandle/targetHandle; manual positioning with node.measured?.height ?? 200; setCenter pan to new node	Medium	Test left-side and right-side edge routing explicitly
10:00â€“11:30	Frontend: Branching from AnswerNode; relaxed branch prompt; sourceHandle: "right" from AnswerNode	Medium	Reuse same hook
11:30â€“13:00	Frontend: Node status system, symmetric toggles, MiniMap status colours, isStreaming gates buttons	Low	
13:00â€“14:30	Frontend: Persistent highlights â€” memo'd substitution with code-block protection; rehype-sanitize custom schema extending defaultSchema; click-to-navigate via data-highlight-id â†’ setCenter	Medium	Test highlights that appear inside code blocks â€” must not inject <mark> into code content
14:30â€“16:00	Backend /api/quiz with response_schema + Frontend Revision Mode modal: 4 MCQs, one-at-a-time, score screen	Medium	
16:00â€“17:30	Polish: upload loading state, post-stream cascade correction pass, edge label white pills, error toasts, Phase 2â†’3 font-match visual transition check	Low	
17:30â€“19:00	Buffer â€” safety net for overruns. Absolutely no new features.	â€”	
19:00â€“20:30	Demo prep: upload UCL lecture PDF, verify localStorage restores canvas instantly on page reload, run full demo script end-to-end	Low	
20:30â€“22:00	Pitch slide + rehearse demo (target: 3 minutes, 10 steps)	Low	
22:00â€“24:00	Critical bug fixes only â€” no new features	â€”	
8. Demo Script for Judges
App loads â€” localStorage instantly restores the canvas with a UCL "Introduction to Machine Learning" lecture in the Content Node. No upload wait

Point to the MiniMap: "The entire 15-page lecture â€” all of it visible and queryable"

Scroll to the gradient descent section â†’ highlight "gradient descent minimises the loss function" â†’ "âœ¨ Ask Gemini" popup appears

Click popup â†’ modal opens with the text quoted â†’ type "Why do we need to minimise loss?" â†’ Ask

Answer Node streams in to the right; animated dashed arrow connects them; edge label shows the question; selected phrase turns permanently yellow in the Content Node

Highlight "local minimum" inside the Answer Node â†’ branch â†’ "Give me a real-world example of getting stuck in a local minimum"

Second Answer Node spawns, connected to the first

Click "âœ— Struggling" on the first Answer Node â†’ border turns red â†’ MiniMap dot turns red

Click "ğŸ“ Revision Mode" â†’ 4 targeted MCQs on gradient descent â†’ answer one â†’ score shown

Close with: "In 5 minutes, you built a visual map of exactly what you don't understand about your lecture. No scrolling. No context switching. No copy-pasting into ChatGPT. Just you, your document, and a map of your own comprehension."